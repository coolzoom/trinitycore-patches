From faa853ad77ebb158a0fffa7a9e53414b74345534 Mon Sep 17 00:00:00 2001
From: Siegels <siegels.admin@gmail.com>
Date: Fri, 16 Apr 2010 23:30:56 +0200
Subject: [PATCH 2/2] MoveVendorItem

Allow custom display order in vendor lists
---
 sql/mangos.sql         |    1 +
 src/game/Chat.cpp      |    1 +
 src/game/Chat.h        |    1 +
 src/game/Language.h    |    1 +
 src/game/Level2.cpp    |   36 +++++++++++++++++++++++++++++++++++-
 src/game/ObjectMgr.cpp |   23 ++++++++++++++++++++---
 src/game/ObjectMgr.h   |    3 ++-
 7 files changed, 61 insertions(+), 5 deletions(-)

diff --git a/sql/mangos.sql b/sql/mangos.sql
index b1e934e..26df1df 100644
--- a/sql/mangos.sql
+++ b/sql/mangos.sql
@@ -3829,6 +3829,7 @@ CREATE TABLE `npc_vendor` (
   `maxcount` tinyint(3) unsigned NOT NULL default '0',
   `incrtime` int(10) unsigned NOT NULL default '0',
   `ExtendedCost` mediumint(8) unsigned NOT NULL default '0',
+  `sortOrder` tinyint(3) unsigned NOT NULL default '0',
   PRIMARY KEY  (`entry`,`item`,`ExtendedCost`)
 ) ENGINE=MyISAM DEFAULT CHARSET=utf8 ROW_FORMAT=FIXED COMMENT='Npc System';
 
diff --git a/src/game/Chat.cpp b/src/game/Chat.cpp
index a3f9153..133ab64 100644
--- a/src/game/Chat.cpp
+++ b/src/game/Chat.cpp
@@ -346,6 +346,7 @@ ChatCommand * ChatHandler::getCommandTable()
         { "follow",         SEC_GAMEMASTER,     false, &ChatHandler::HandleNpcFollowCommand,           "", NULL },
         { "info",           SEC_ADMINISTRATOR,  false, &ChatHandler::HandleNpcInfoCommand,             "", NULL },
         { "move",           SEC_GAMEMASTER,     false, &ChatHandler::HandleNpcMoveCommand,             "", NULL },
+        { "moveitem",       SEC_GAMEMASTER,     false, &ChatHandler::HandleNpcMoveVendorItemCommand,   "", NULL },
         { "playemote",      SEC_ADMINISTRATOR,  false, &ChatHandler::HandleNpcPlayEmoteCommand,        "", NULL },
         { "setmodel",       SEC_GAMEMASTER,     false, &ChatHandler::HandleNpcSetModelCommand,         "", NULL },
         { "setmovetype",    SEC_GAMEMASTER,     false, &ChatHandler::HandleNpcSetMoveTypeCommand,      "", NULL },
diff --git a/src/game/Chat.h b/src/game/Chat.h
index bea9f9e..a598445 100644
--- a/src/game/Chat.h
+++ b/src/game/Chat.h
@@ -282,6 +282,7 @@ class ChatHandler
         bool HandleNpcFollowCommand(const char* args);
         bool HandleNpcInfoCommand(const char* args);
         bool HandleNpcMoveCommand(const char* args);
+        bool HandleNpcMoveVendorItemCommand(const char* args);
         bool HandleNpcPlayEmoteCommand(const char* args);
         bool HandleNpcSayCommand(const char* args);
         bool HandleNpcSetDeathStateCommand(const char* args);
diff --git a/src/game/Language.h b/src/game/Language.h
index 2802c68..6786731 100644
--- a/src/game/Language.h
+++ b/src/game/Language.h
@@ -832,6 +832,7 @@ enum MangosStrings
 
     // Use for not-in-offcial-sources patches
     //                                    10000-10999
+    LANG_ITEM_MOVED_IN_LIST				= 10000,
 
     // Use for custom patches             11000-11999
 
diff --git a/src/game/Level2.cpp b/src/game/Level2.cpp
index 9c524e7..df161b0 100644
--- a/src/game/Level2.cpp
+++ b/src/game/Level2.cpp
@@ -1131,6 +1131,9 @@ bool ChatHandler::HandleNpcAddVendorItemCommand(const char* args)
     char* fextendedcost = strtok(NULL, " ");                //add ExtendedCost, default: 0
     uint32 extendedcost = fextendedcost ? atol(fextendedcost) : 0;
 
+    char* fsortorder = strtok(NULL, " ");                //add SortOrder, default: 0
+    uint32 sortorder = fsortorder ? atol(fsortorder) : 0;
+    
     Creature* vendor = getSelectedCreature();
 
     uint32 vendor_entry = vendor ? vendor->GetEntry() : 0;
@@ -1141,7 +1144,7 @@ bool ChatHandler::HandleNpcAddVendorItemCommand(const char* args)
         return false;
     }
 
-    sObjectMgr.AddVendorItem(vendor_entry,itemId,maxcount,incrtime,extendedcost);
+    sObjectMgr.AddVendorItem(vendor_entry,itemId,maxcount,incrtime,extendedcost,sortorder);
 
     ItemPrototype const* pProto = ObjectMgr::GetItemPrototype(itemId);
 
@@ -1149,6 +1152,37 @@ bool ChatHandler::HandleNpcAddVendorItemCommand(const char* args)
     return true;
 }
 
+//move item in vendor list
+bool ChatHandler::HandleNpcMoveVendorItemCommand(const char* args)
+{
+	char* pitem  = extractKeyFromLink((char*)args,"Hitem");
+    if (!pitem)
+    {
+        SendSysMessage(LANG_COMMAND_NEEDITEMSEND);
+        SetSentErrorMessage(true);
+        return false;
+    }
+    uint32 itemId = atol(pitem);
+    
+    char* fsortorder = strtok(NULL, " ");                //add SortOrder, default: 0
+    uint32 sortorder = fsortorder ? atol(fsortorder) : 0;
+    
+    Creature* vendor = getSelectedCreature();
+    if (!vendor || !vendor->isVendor())
+    {
+        SendSysMessage(LANG_COMMAND_VENDORSELECTION);
+        SetSentErrorMessage(true);
+        return false;
+    }
+    uint32 vendor_entry = vendor ? vendor->GetEntry() : 0;
+    
+    sObjectMgr.MoveVendorItem(vendor_entry,itemId,sortorder);
+    ItemPrototype const* pProto = ObjectMgr::GetItemPrototype(itemId);
+    
+	PSendSysMessage(LANG_ITEM_MOVED_IN_LIST,itemId,pProto->Name1,sortorder);
+	return true;
+}
+
 //del item from vendor list
 bool ChatHandler::HandleNpcDelVendorItemCommand(const char* args)
 {
diff --git a/src/game/ObjectMgr.cpp b/src/game/ObjectMgr.cpp
index b5ca24c..9e112d6 100644
--- a/src/game/ObjectMgr.cpp
+++ b/src/game/ObjectMgr.cpp
@@ -7958,7 +7958,7 @@ void ObjectMgr::LoadVendors()
 
     std::set<uint32> skip_vendors;
 
-    QueryResult *result = WorldDatabase.Query("SELECT entry, item, maxcount, incrtime, ExtendedCost FROM npc_vendor");
+    QueryResult *result = WorldDatabase.Query("SELECT entry, item, maxcount, incrtime, ExtendedCost FROM npc_vendor ORDER BY sortOrder");
     if( !result )
     {
         barGoLink bar( 1 );
@@ -8260,12 +8260,14 @@ void ObjectMgr::LoadGossipMenuItems()
     sLog.outString(">> Loaded %u gossip_menu_option entries", count);
 }
 
-void ObjectMgr::AddVendorItem( uint32 entry,uint32 item, uint32 maxcount, uint32 incrtime, uint32 extendedcost )
+void ObjectMgr::AddVendorItem( uint32 entry,uint32 item, uint32 maxcount, uint32 incrtime, uint32 extendedcost, uint32 sortOrder )
 {
     VendorItemData& vList = m_mCacheVendorItemMap[entry];
     vList.AddItem(item,maxcount,incrtime,extendedcost);
 
-    WorldDatabase.PExecuteLog("INSERT INTO npc_vendor (entry,item,maxcount,incrtime,extendedcost) VALUES('%u','%u','%u','%u','%u')",entry, item, maxcount,incrtime,extendedcost);
+    WorldDatabase.PExecuteLog("UPDATE npc_vendor SET sortOrder = sortOrder + 1 WHERE entry = %u AND sortOrder >= %u",entry,sortOrder);
+
+    WorldDatabase.PExecuteLog("INSERT INTO npc_vendor (entry,item,maxcount,incrtime,extendedcost,sortOrder) VALUES('%u','%u','%u','%u','%u','%u')",entry, item, maxcount,incrtime,extendedcost,sortOrder);
 }
 
 bool ObjectMgr::RemoveVendorItem( uint32 entry,uint32 item )
@@ -8277,10 +8279,25 @@ bool ObjectMgr::RemoveVendorItem( uint32 entry,uint32 item )
     if(!iter->second.RemoveItem(item))
         return false;
 
+    WorldDatabase.PExecuteLog("UPDATE npc_vendor SET sortOrder = sortOrder - 1 WHERE sortOrder > (SELECT sortOrder FROM npc_vendor WHERE entry='%u' AND item='%u' LIMIT 1) AND entry = '%u'",entry,item,entry);
     WorldDatabase.PExecuteLog("DELETE FROM npc_vendor WHERE entry='%u' AND item='%u'",entry, item);
     return true;
 }
 
+bool ObjectMgr::MoveVendorItem( uint32 entry,uint32 item,uint32 sortorder )
+{
+    CacheVendorItemMap::iterator  iter = m_mCacheVendorItemMap.find(entry);
+    if(iter == m_mCacheVendorItemMap.end())
+        return false;
+
+    if(!iter->second.RemoveItem(item))
+        return false;
+    
+    WorldDatabase.PExecuteLog("UPDATE npc_vendor SET sortOrder='%u' WHERE entry='%u' AND item='%u'", sortorder, entry, item);
+    WorldDatabase.PExecuteLog("UPDATE npc_vendor SET sortOrder= sortOrder + 1 WHERE entry='%u' AND sortOrder>='%u'", entry, sortorder);
+    return true;
+}
+
 bool ObjectMgr::IsVendorItemValid( uint32 vendor_entry, uint32 item_id, uint32 maxcount, uint32 incrtime, uint32 ExtendedCost, Player* pl, std::set<uint32>* skip_vendors ) const
 {
     CreatureInfo const* cInfo = GetCreatureTemplate(vendor_entry);
diff --git a/src/game/ObjectMgr.h b/src/game/ObjectMgr.h
index a989f26..fab3381 100644
--- a/src/game/ObjectMgr.h
+++ b/src/game/ObjectMgr.h
@@ -862,7 +862,8 @@ class ObjectMgr
 
             return &iter->second;
         }
-        void AddVendorItem(uint32 entry,uint32 item, uint32 maxcount, uint32 incrtime, uint32 ExtendedCost);
+        void AddVendorItem(uint32 entry,uint32 item, uint32 maxcount, uint32 incrtime, uint32 ExtendedCost, uint32 sortOrder);
+        bool MoveVendorItem(uint32 entry,uint32 item,uint32 sortorder);
         bool RemoveVendorItem(uint32 entry,uint32 item);
         bool IsVendorItemValid( uint32 vendor_entry, uint32 item, uint32 maxcount, uint32 ptime, uint32 ExtendedCost, Player* pl = NULL, std::set<uint32>* skip_vendors = NULL ) const;
 
-- 
1.6.3.3