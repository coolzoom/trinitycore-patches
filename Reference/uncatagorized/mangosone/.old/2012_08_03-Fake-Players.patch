From daa0875d94aa598620e2483eb8c3eaa3a0953e68 Mon Sep 17 00:00:00 2001
From: Surion <realmsofwarcraft@gmail.com>
Date: Thu, 2 Aug 2012 05:33:27 -0500
Subject: [PATCH] 2012_08_03-Fake-Players

---
 src/game/ChatHandler.cpp         |    9 +++++++++
 src/game/Language.h              |    2 ++
 src/game/MiscHandler.cpp         |   33 +++++++++++++++++++++++++++++++++
 src/game/Player.cpp              |    4 ++++
 src/game/World.cpp               |    1 +
 src/game/World.h                 |    1 +
 src/mangosd/mangosd.conf.dist.in |   10 +++++++++-
 7 files changed, 59 insertions(+), 1 deletions(-)

diff --git a/src/game/ChatHandler.cpp b/src/game/ChatHandler.cpp
index e048e2e..269e9e5 100644
--- a/src/game/ChatHandler.cpp
+++ b/src/game/ChatHandler.cpp
@@ -213,8 +213,17 @@ void WorldSession::HandleMessagechatOpcode( WorldPacket & recv_data )
             uint32 pSecurity = player ? player->GetSession()->GetSecurity() : SEC_PLAYER;
             if (!player || (tSecurity == SEC_PLAYER && pSecurity > SEC_PLAYER && !player->isAcceptWhispers()))
             {
+                // If Fake WHO List system on then show player DND
+                if (sWorld.getConfig(CONFIG_BOOL_FAKE_WHO_LIST))
+                {
+                    SendNotification(LANG_NOT_WHISPER);
+                    return;
+                }
+                else
+                {
                 SendPlayerNotFoundNotice(to);
                 return;
+                }
             }
 
             if (!sWorld.getConfig(CONFIG_BOOL_ALLOW_TWO_SIDE_INTERACTION_CHAT) && tSecurity == SEC_PLAYER && pSecurity == SEC_PLAYER )
diff --git a/src/game/Language.h b/src/game/Language.h
index 101af05..f9c18cc 100644
--- a/src/game/Language.h
+++ b/src/game/Language.h
@@ -982,6 +982,8 @@ enum MangosStrings
     //                                    10000-10999
 
     LANG_INVALID_REALMID                = 11001,
+	// Fake Players
+    LANG_NOT_WHISPER                    = 12001,
 
     // Use for custom patches             11000-11999
 
diff --git a/src/game/MiscHandler.cpp b/src/game/MiscHandler.cpp
index 93e8443..a3e7d9a 100644
--- a/src/game/MiscHandler.cpp
+++ b/src/game/MiscHandler.cpp
@@ -251,6 +251,39 @@ void WorldSession::HandleWhoOpcode( WorldPacket & recv_data )
             break;
     }
 
+    if (sWorld.getConfig(CONFIG_BOOL_FAKE_WHO_LIST) && clientcount < 49)
+    {
+        // Fake players on WHO LIST                            0,   1,    2,   3,    4,   5     6
+        QueryResult *result = CharacterDatabase.Query("SELECT guid,name,race,class,level,zone,gender FROM characters_fake WHERE online > 1");
+        if (result)
+        {
+            do
+            {
+                Field *fields = result->Fetch();
+
+                std::string pname = fields[1].GetCppString();    // player name
+                std::string gname;                                // guild name
+                uint32 lvl = fields[4].GetUInt32();                // player level
+                uint32 class_ = fields[3].GetUInt32();            // player class
+                uint32 race = fields[2].GetUInt32();            // player race
+                uint32 pzoneid = fields[5].GetUInt32();            // player zone id
+                uint8 gender = fields[6].GetUInt8();            // player gender
+
+                data << pname;                              // player name
+                data << gname;                              // guild name
+                data << uint32(lvl);                        // player level
+                data << uint32(class_);                     // player class
+                data << uint32(race);                       // player race
+                data << uint8(gender);                      // player gender
+                data << uint32(pzoneid);                    // player zone id
+
+                if ((++clientcount) == 49)
+                    break;
+            } while (result->NextRow());
+        }
+        delete result;
+    }
+
     uint32 count = m.size();
     data.put( 0, clientcount );                             // insert right count, listed count
     data.put( 4, count > 50 ? count : clientcount );        // insert right count, online count
diff --git a/src/game/Player.cpp b/src/game/Player.cpp
index 12be75e..408e8c8 100644
--- a/src/game/Player.cpp
+++ b/src/game/Player.cpp
@@ -1290,6 +1290,10 @@ void Player::Update(uint32 update_diff, uint32 p_time)
             // m_nextSave reseted in SaveToDB call
             SaveToDB();
             DETAIL_LOG("Player '%s' (GUID: %u) saved", GetName(), GetGUIDLow());
+            // If Fake WHO List system on then change player position with every SavePlayer Interval (usually 15min)
+            if (sWorld.getConfig(CONFIG_BOOL_FAKE_WHO_LIST))
+                CharacterDatabase.PExecute("UPDATE characters SET zone = (FLOOR(50 * RAND()) + 1) WHERE online>1");
+                CharacterDatabase.PExecute("UPDATE characters SET level=level+1 WHERE online>1 AND level<5");
         }
         else
             m_nextSave -= update_diff;
diff --git a/src/game/World.cpp b/src/game/World.cpp
index 2a8cf5c..2273b02 100644
--- a/src/game/World.cpp
+++ b/src/game/World.cpp
@@ -544,6 +544,7 @@ void World::LoadConfigSettings(bool reload)
     setConfig(CONFIG_BOOL_ALLOW_TWO_SIDE_INTERACTION_MAIL,    "AllowTwoSide.Interaction.Mail", false);
     setConfig(CONFIG_BOOL_ALLOW_TWO_SIDE_WHO_LIST,            "AllowTwoSide.WhoList", false);
     setConfig(CONFIG_BOOL_ALLOW_TWO_SIDE_ADD_FRIEND,          "AllowTwoSide.AddFriend", false);
+    setConfig(CONFIG_BOOL_FAKE_WHO_LIST,                      "Fake.WHO.List", false);
 
     setConfig(CONFIG_UINT32_STRICT_PLAYER_NAMES,  "StrictPlayerNames",  0);
     setConfig(CONFIG_UINT32_STRICT_CHARTER_NAMES, "StrictCharterNames", 0);
diff --git a/src/game/World.h b/src/game/World.h
index 2124541..7e52c63 100644
--- a/src/game/World.h
+++ b/src/game/World.h
@@ -282,6 +282,7 @@ enum eConfigBoolValues
     CONFIG_BOOL_ALLOW_TWO_SIDE_INTERACTION_MAIL,
     CONFIG_BOOL_ALLOW_TWO_SIDE_WHO_LIST,
     CONFIG_BOOL_ALLOW_TWO_SIDE_ADD_FRIEND,
+    CONFIG_BOOL_FAKE_WHO_LIST,
     CONFIG_BOOL_INSTANCE_IGNORE_LEVEL,
     CONFIG_BOOL_INSTANCE_IGNORE_RAID,
     CONFIG_BOOL_CAST_UNSTUCK,
diff --git a/src/mangosd/mangosd.conf.dist.in b/src/mangosd/mangosd.conf.dist.in
index 0268da2..a102308 100644
--- a/src/mangosd/mangosd.conf.dist.in
+++ b/src/mangosd/mangosd.conf.dist.in
@@ -208,7 +208,7 @@ MaxOverspeedPings = 2
 GridUnload = 1
 GridCleanUpDelay = 300000
 MapUpdateInterval = 100
-ChangeWeatherInterval = 600000
+ChangeWeatherInterval = 5400000# 90 minutes
 PlayerSave.Interval = 900000
 PlayerSave.Stats.MinLevel = 0
 PlayerSave.Stats.SaveOnlyOnLogout = 1
@@ -815,6 +815,13 @@ Motd = "Welcome to the Massive Network Game Object Server."
 #        Default: 1 (allow)
 #                 0 (not allow)
 #
+#    Fake.WHO.List
+#        Add fake players to fill in WHO LIST (who is online list, "O" button) if there is less then
+#        49 real players online (need to set online=2 in character database in order to work)
+#        Default: 0 (disabled)
+#                 1 (enabled)
+#
+#
 ###################################################################################################################
 
 AllowTwoSide.Accounts = 0
@@ -827,6 +834,7 @@ AllowTwoSide.Interaction.Mail = 0
 AllowTwoSide.WhoList = 0
 AllowTwoSide.AddFriend = 0
 TalentsInspecting = 1
+Fake.Who.List = 0
 
 ###################################################################################################################
 # CREATURE AND GAMEOBJECT SETTINGS
-- 
1.7.2.5

