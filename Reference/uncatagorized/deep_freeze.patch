# HG changeset patch
# User DrTenma <dr.tenma@yahoo.com>
# Date 1285631353 10800
# Branch trunk
# Node ID d8e53205ad468beee4c6036ccd597071011e38e9
# Parent  ae81dd460ccb4159bbd3145e42cef429a52c59d9
Deep Freeze fix.

diff -r ae81dd460ccb -r d8e53205ad46 sql/updates/065_world_playercreateinfo_spell.sql
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/sql/updates/065_world_playercreateinfo_spell.sql	Mon Sep 27 20:49:13 2010 -0300
@@ -0,0 +1,8 @@
+DELETE FROM `playercreateinfo_spell` WHERE `Spell` IN ('71761');
+INSERT INTO `playercreateinfo_spell` (`race`, `class`, `Spell`, `Note`) VALUES
+('1','8','71761','Deep Freeze Immunity State'),
+('5','8','71761','Deep Freeze Immunity State'),
+('7','8','71761','Deep Freeze Immunity State'),
+('8','8','71761','Deep Freeze Immunity State'),
+('10','8','71761','Deep Freeze Immunity State'),
+('11','8','71761','Deep Freeze Immunity State');
diff -r ae81dd460ccb -r d8e53205ad46 sql/updates/065_world_spell_bonus_data.sql
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/sql/updates/065_world_spell_bonus_data.sql	Mon Sep 27 20:49:13 2010 -0300
@@ -0,0 +1,3 @@
+DELETE FROM `spell_bonus_data` WHERE `entry` IN ('71757');
+INSERT INTO `spell_bonus_data` (`entry`, `direct_bonus`, `dot_bonus`, `ap_bonus`, `ap_dot_bonus`, `comments`) VALUES
+('71757','2.143','0','0','0','Mage - Deep Freeze');
diff -r ae81dd460ccb -r d8e53205ad46 sql/updates/065_world_spell_proc_event.sql
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/sql/updates/065_world_spell_proc_event.sql	Mon Sep 27 20:49:13 2010 -0300
@@ -0,0 +1,3 @@
+DELETE FROM `spell_proc_event` WHERE `entry` IN ('71761');
+INSERT INTO `spell_proc_event` (`entry`, `SchoolMask`, `SpellFamilyName`, `SpellFamilyMask0`, `SpellFamilyMask1`, `SpellFamilyMask2`, `procFlags`, `procEx`, `ppmRate`, `CustomChance`, `Cooldown`) VALUES
+('71761','0','3','0','1048576','0','0','256','0','0','0'); -- Deep Freeze Immunity State
diff -r ae81dd460ccb -r d8e53205ad46 src/server/game/Entities/Unit/Unit.cpp
--- a/src/server/game/Entities/Unit/Unit.cpp	Mon Sep 27 23:27:52 2010 +0200
+++ b/src/server/game/Entities/Unit/Unit.cpp	Mon Sep 27 20:49:13 2010 -0300
@@ -8563,6 +8563,19 @@
         case 72176:
             basepoints0 = 3;
             break;
+        case 71761: // Deep Freeze Immunity State
+        {
+            if (!pVictim->ToCreature())
+                return false;
+
+            if (pVictim->ToCreature()->GetCreatureInfo()->MechanicImmuneMask & (1 << procSpell->EffectMechanic[EFFECT_0]))
+                target = pVictim;
+            else
+                return false;
+            break;
+        }
+        default:
+            break;
     }
 
     // Blade Barrier
@@ -10614,16 +10627,17 @@
                 {
                     if (!((*i)->IsAffectedOnSpell(spellProto)))
                         continue;
-                    int32 modChance=0;
+
+                    int32 modChance = 0;
                     switch((*i)->GetMiscValue())
                     {
                         // Shatter
-                        case  911: modChance+= 16;
-                        case  910: modChance+= 17;
-                        case  849: modChance+= 17;
-                            if (!pVictim->HasAuraState(AURA_STATE_FROZEN, spellProto, this))
-                                break;
-                            crit_chance+=modChance;
+                        case  911: modChance += 16;
+                        case  910: modChance += 17;
+                        case  849: modChance += 17;
+                            // Deep Freeze damage trigger is always shattered and does not consume FoF charges
+                            if ((spellProto->Id == 71757) || pVictim->HasAuraState(AURA_STATE_FROZEN, spellProto, this))
+                                crit_chance += modChance;
                             break;
                         case 7917: // Glyph of Shadowburn
                             if (pVictim->HasAuraState(AURA_STATE_HEALTHLESS_35_PERCENT, spellProto, this))
diff -r ae81dd460ccb -r d8e53205ad46 src/server/game/Spells/Spell.cpp
--- a/src/server/game/Spells/Spell.cpp	Mon Sep 27 23:27:52 2010 +0200
+++ b/src/server/game/Spells/Spell.cpp	Mon Sep 27 20:49:13 2010 -0300
@@ -1240,13 +1240,19 @@
             positive = false;
         else if (!m_healing)
         {
-            for (uint8 i = 0; i< MAX_SPELL_EFFECTS; ++i)
-                // If at least one effect negative spell is negative hit
-                if (mask & (1<<i) && !IsPositiveEffect(m_spellInfo->Id, i))
-                {
-                    positive = false;
-                    break;
-                }
+            if (mask)
+            {
+                for (uint8 effIndex = 0; effIndex < MAX_SPELL_EFFECTS; ++effIndex)
+                    // If at least one effect negative spell is negative hit
+                    if (mask & (1 << effIndex) && !IsPositiveEffect(m_spellInfo->Id, effIndex))
+                    {
+                        positive = false;
+                        break;
+                    }
+            }
+            else
+                // If there is no effect mask determine from spell proto
+                positive = IsPositiveSpell(m_spellInfo->Id);
         }
         switch(m_spellInfo->DmgClass)
         {