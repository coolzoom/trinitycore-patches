From 9492f7d70d6de7af77bccde0b52ff3c2f5e6423d Mon Sep 17 00:00:00 2001
From: LordPsyan <realmsofwarcraft@gmail.com>
Date: Sun, 24 Aug 2014 16:40:05 -0400
Subject: [PATCH] Individual-XP-Rate

---
 .../auth_individuale_xp_Rate.sql                   |  5 ++
 .../world_individuale_xp_Rate.sql                  |  8 +++
 src/server/game/Accounts/RBAC.h                    |  2 +
 src/server/game/Entities/Player/Player.cpp         | 25 ++++++++-
 src/server/game/Entities/Player/Player.h           | 16 ++++++
 src/server/game/Miscellaneous/Formulas.h           |  5 +-
 src/server/game/Miscellaneous/Language.h           |  9 ++-
 src/server/scripts/Commands/cs_modify.cpp          | 64 ++++++++++++++++++++++
 8 files changed, 130 insertions(+), 4 deletions(-)
 create mode 100644 sql/TrinityCore-Patches/Individuale_XP-Rate/auth_individuale_xp_Rate.sql
 create mode 100644 sql/TrinityCore-Patches/Individuale_XP-Rate/world_individuale_xp_Rate.sql

diff --git a/sql/TrinityCore-Patches/Individuale_XP-Rate/auth_individuale_xp_Rate.sql b/sql/TrinityCore-Patches/Individuale_XP-Rate/auth_individuale_xp_Rate.sql
new file mode 100644
index 0000000..145342c
--- /dev/null
+++ b/sql/TrinityCore-Patches/Individuale_XP-Rate/auth_individuale_xp_Rate.sql
@@ -0,0 +1,5 @@
+INSERT INTO `rbac_permissions` VALUES ('1010', 'Command: modify xpkill');
+INSERT INTO `rbac_permissions` VALUES ('1011', 'Command: modify xpquest');
+
+INSERT INTO `rbac_linked_permissions` VALUES ('195', '1010');
+INSERT INTO `rbac_linked_permissions` VALUES ('195', '1011');
diff --git a/sql/TrinityCore-Patches/Individuale_XP-Rate/world_individuale_xp_Rate.sql b/sql/TrinityCore-Patches/Individuale_XP-Rate/world_individuale_xp_Rate.sql
new file mode 100644
index 0000000..f310d3d
--- /dev/null
+++ b/sql/TrinityCore-Patches/Individuale_XP-Rate/world_individuale_xp_Rate.sql
@@ -0,0 +1,8 @@
+INSERT INTO `trinity_string` VALUES ('15004', 'Current XpKill Rate: %f.$BCurrent XpQuest Rate: %f.', null, null, null, null, null, null, null, null);
+INSERT INTO `trinity_string` VALUES ('15003', 'The specified value is too low, it should be between 1 and 8.', null, null, null, null, null, null, null, null);
+INSERT INTO `trinity_string` VALUES ('15001', 'XpQuest Rate set to %f ', null, null, null, null, null, null, null, null);
+INSERT INTO `trinity_string` VALUES ('15002', 'The specified value is too high, it should be between 1 and 8.', null, null, null, null, null, null, null, null);
+INSERT INTO `trinity_string` VALUES ('15000', 'XpKill Rate set to %f ', null, null, null, null, null, null, null, null);
+
+INSERT INTO `command` VALUES ('modify xpkill', '1010', 'Syntax: .modify xpkill #wert');
+INSERT INTO `command` VALUES ('modify xpquest', '1011', 'Syntax: .modify xpquest #wert');
\ No newline at end of file
diff --git a/src/server/game/Accounts/RBAC.h b/src/server/game/Accounts/RBAC.h
index 855ffd5..5a7a49d 100644
--- a/src/server/game/Accounts/RBAC.h
+++ b/src/server/game/Accounts/RBAC.h
@@ -683,6 +683,8 @@ enum RBACPermissions
     RBAC_PERM_COMMAND_MAILBOX                                = 777,
 
     // custom permissions 1000+
+    RBAC_PERM_COMMAND_MODIFY_XP_KILL                         = 1010,
+    RBAC_PERM_COMMAND_MODIFY_XP_QUEST                        = 1011,
     RBAC_PERM_MAX
 };
 
diff --git a/src/server/game/Entities/Player/Player.cpp b/src/server/game/Entities/Player/Player.cpp
index 1fc1cd9..2900612 100644
--- a/src/server/game/Entities/Player/Player.cpp
+++ b/src/server/game/Entities/Player/Player.cpp
@@ -902,6 +902,10 @@ Player::Player(WorldSession* session): Unit(true)
     _activeCheats = CHEAT_NONE;
     m_achievementMgr = new AchievementMgr(this);
     m_reputationMgr = new ReputationMgr(this);
+
+    //Individuale_XP-Rate
+    _individual_kill = 0.0f;
+    _individual_quest = 0.0f;
 }
 
 Player::~Player()
@@ -15309,7 +15313,7 @@ void Player::RewardQuest(Quest const* quest, uint32 reward, Object* questGiver,
     bool rewarded = (m_RewardedQuests.find(quest_id) != m_RewardedQuests.end());
 
     // Not give XP in case already completed once repeatable quest
-    uint32 XP = rewarded ? 0 : uint32(quest->XPValue(this)*sWorld->getRate(RATE_XP_QUEST));
+    uint32 XP = rewarded ? 0 : uint32(quest->XPValue(this)*(_individual_quest > 0 ? _individual_quest : sWorld->getRate(RATE_XP_QUEST)));
 
     // handle SPELL_AURA_MOD_XP_QUEST_PCT auras
     Unit::AuraEffectList const& ModXPPctAuras = GetAuraEffectsByType(SPELL_AURA_MOD_XP_QUEST_PCT);
@@ -26830,6 +26834,25 @@ bool Player::IsLoading() const
     return GetSession()->PlayerLoading();
 }
 
+//Individuale_XP-Rate
+void Player::SetIndividualRate(IndividualXpRate rate, float value)
+{
+    if (value < 1 || value > 8)
+        return;
+
+    switch (rate)
+    {
+        case INDIVIDUAL_XP_KILL:
+            _individual_kill = value;
+            break;
+        case INDIVIDUAL_XP_QUEST:
+            _individual_quest = value;
+        break;
+        default:
+            break;
+    }
+}
+
 void Player::SendSupercededSpell(uint32 oldSpell, uint32 newSpell)
 {
     WorldPacket data(SMSG_SUPERCEDED_SPELL, 8);
diff --git a/src/server/game/Entities/Player/Player.h b/src/server/game/Entities/Player/Player.h
index b1fd9d5..bf7be1f 100644
--- a/src/server/game/Entities/Player/Player.h
+++ b/src/server/game/Entities/Player/Player.h
@@ -917,6 +917,13 @@ enum PlayerCommandStates
     CHEAT_WATERWALK = 0x10
 };
 
+//Individuale_XP-Rate
+enum IndividualXpRate
+{
+    INDIVIDUAL_XP_KILL  = 1,
+    INDIVIDUAL_XP_QUEST = 2,
+};
+
 class PlayerTaxi
 {
     public:
@@ -2340,6 +2347,11 @@ class Player : public Unit, public GridObject<Player>
 
         bool IsLoading() const;
 
+        //Individuale_XP-Rate
+        void SetIndividualRate(IndividualXpRate rate, float value);
+        float GetIndividualXpKillRate() { return _individual_kill; };
+        float GetIndividualXpQuestRate() { return _individual_quest; };
+
     protected:
         // Gamemaster whisper whitelist
         WhisperListContainer WhisperList;
@@ -2668,6 +2680,10 @@ class Player : public Unit, public GridObject<Player>
         uint32 _pendingBindTimer;
 
         uint32 _activeCheats;
+
+        //Individuale_XP-Rate
+        float _individual_kill;
+        float _individual_quest;
 };
 
 void AddItemsSetItem(Player* player, Item* item);
diff --git a/src/server/game/Miscellaneous/Formulas.h b/src/server/game/Miscellaneous/Formulas.h
index e6ff1a0..0afc417 100644
--- a/src/server/game/Miscellaneous/Formulas.h
+++ b/src/server/game/Miscellaneous/Formulas.h
@@ -183,9 +183,10 @@ namespace Trinity
 
                     xpMod *= creature->GetCreatureTemplate()->ModExperience;
                 }
+                //Individuale_XP-Rate
+                float individualXpKill = player->GetIndividualXpKillRate();
 
-                xpMod *= sWorld->getRate(RATE_XP_KILL);
-                gain = uint32(gain * xpMod);
+                gain = uint32(gain * (individualXpKill > 0 ? individualXpKill : sWorld->getRate(RATE_XP_KILL)));
             }
 
             sScriptMgr->OnGainCalculation(gain, player, u);
diff --git a/src/server/game/Miscellaneous/Language.h b/src/server/game/Miscellaneous/Language.h
index f4d1bc0..5d208ae 100644
--- a/src/server/game/Miscellaneous/Language.h
+++ b/src/server/game/Miscellaneous/Language.h
@@ -1172,7 +1172,14 @@ enum TrinityStrings
     LANG_BAN_ACCOUNT_YOUPERMBANNEDMESSAGE_WORLD   = 11007,
 
     LANG_NPCINFO_INHABIT_TYPE                     = 11008,
-    LANG_NPCINFO_FLAGS_EXTRA                      = 11009
+    LANG_NPCINFO_FLAGS_EXTRA                      = 11009,
+
+    //Individuale_XP-Rate
+    LANG_INDIVIDUAL_KILLRATE_SET                  = 15000,
+    LANG_INDIVIDUAL_QUESTRATE_SET                 = 15001,
+    LANG_INDIVIDUAL_RATE_TO_HIGH                  = 15002,
+    LANG_INDIVIDUAL_RATE_TO_LOW                   = 15003,
+    LANG_INDIVIDUAL_RATES_INFO                    = 15004,
 
     // NOT RESERVED IDS                   12000-1999999999
     // `db_script_string` table index     2000000000-2000009999 (MIN_DB_SCRIPT_STRING_ID-MAX_DB_SCRIPT_STRING_ID)
diff --git a/src/server/scripts/Commands/cs_modify.cpp b/src/server/scripts/Commands/cs_modify.cpp
index 5dbe95b..e2c592b 100644
--- a/src/server/scripts/Commands/cs_modify.cpp
+++ b/src/server/scripts/Commands/cs_modify.cpp
@@ -70,6 +70,8 @@ public:
             { "spell",        rbac::RBAC_PERM_COMMAND_MODIFY_SPELL,        false, &HandleModifySpellCommand,         "", NULL },
             { "standstate",   rbac::RBAC_PERM_COMMAND_MODIFY_STANDSTATE,   false, &HandleModifyStandStateCommand,    "", NULL },
             { "talentpoints", rbac::RBAC_PERM_COMMAND_MODIFY_TALENTPOINTS, false, &HandleModifyTalentCommand,        "", NULL },
+            { "xpkill",       rbac::RBAC_PERM_COMMAND_MODIFY_XP_KILL,      false, &HandleModifyXpKillCommand, "", NULL },
+            { "xpquest",      rbac::RBAC_PERM_COMMAND_MODIFY_XP_QUEST,     false, &HandleModifyXpQuestCommand, "", NULL },
             { NULL,           0,                                     false, NULL,                              "", NULL }
         };
         static ChatCommand commandTable[] =
@@ -1393,6 +1395,68 @@ public:
 
         return true;
     }
+
+    static bool HandleModifyXpKillCommand(ChatHandler* handler, const char* args)
+    {
+        if (!*args)
+            return false;
+
+        float killRate = (float)atof((char*)args);
+
+        if (killRate < 1)
+        {
+            handler->SendSysMessage(LANG_INDIVIDUAL_RATE_TO_LOW);
+            handler->SetSentErrorMessage(true);
+            return false;
+        }
+
+        if (killRate > 8)
+        {
+            handler->SendSysMessage(LANG_INDIVIDUAL_RATE_TO_HIGH);
+            handler->SetSentErrorMessage(true);
+            return false;
+        }
+
+        if (Player* player = handler->GetSession()->GetPlayer())
+        {
+            player->SetIndividualRate(INDIVIDUAL_XP_KILL, killRate);
+            handler->PSendSysMessage(LANG_INDIVIDUAL_KILLRATE_SET, killRate);
+            return true;
+        }
+
+        return true;
+    }
+
+    static bool HandleModifyXpQuestCommand(ChatHandler* handler, const char* args)
+    {
+        if (!*args)
+            return false;
+
+        float questRate = (float)atof((char*)args);
+
+        if (questRate < 1)
+        {
+            handler->SendSysMessage(LANG_INDIVIDUAL_RATE_TO_LOW);
+            handler->SetSentErrorMessage(true);
+            return false;
+        }
+
+        if (questRate > 8)
+        {
+            handler->SendSysMessage(LANG_INDIVIDUAL_RATE_TO_HIGH);
+            handler->SetSentErrorMessage(true);
+            return false;
+        }
+
+        if (Player* player = handler->GetSession()->GetPlayer())
+        {
+            player->SetIndividualRate(INDIVIDUAL_XP_QUEST, questRate);
+            handler->PSendSysMessage(LANG_INDIVIDUAL_QUESTRATE_SET, questRate);
+            return true;
+        }
+
+        return true;
+    }
 };
 
 void AddSC_modify_commandscript()
-- 
2.1.0.rc1

