From 50089335a5ab631269011d38d0a68e930376004e Mon Sep 17 00:00:00 2001
From: DarkBrain2580 <streetracer1@hotmail.de>
Date: Fri, 19 Sep 2014 17:27:38 +0200
Subject: [PATCH] AHBot Patch (Core)

---
 src/server/game/AuctionHouse/AuctionHouseMgr.cpp   | 15 +++++---
 .../game/AuctionHouseBot/AuctionHouseBot.cpp       |  6 ++++
 src/server/game/AuctionHouseBot/AuctionHouseBot.h  |  5 +++
 .../game/AuctionHouseBot/AuctionHouseBotSeller.cpp | 32 +++++++++++++++--
 src/server/game/Handlers/AuctionHouseHandler.cpp   | 40 +++++++++-------------
 src/server/game/World/World.cpp                    |  2 ++
 src/server/game/World/World.h                      |  1 +
 src/server/worldserver/worldserver.conf.dist       | 34 ++++++++++++++++++
 8 files changed, 105 insertions(+), 30 deletions(-)

diff --git a/src/server/game/AuctionHouse/AuctionHouseMgr.cpp b/src/server/game/AuctionHouse/AuctionHouseMgr.cpp
index f4699f0..709b71c 100644
--- a/src/server/game/AuctionHouse/AuctionHouseMgr.cpp
+++ b/src/server/game/AuctionHouse/AuctionHouseMgr.cpp
@@ -456,7 +456,9 @@ void AuctionHouseObject::Update()
         ///- Either cancel the auction if there was no bidder
         if (auction->bidder == 0)
         {
-            sAuctionMgr->SendAuctionExpiredMail(auction, trans);
+            if (auction->owner != sWorld->getIntConfig(CONFIG_AHBOT_SELL_OWNER))
+                sAuctionMgr->SendAuctionExpiredMail(auction, trans);
+
             sScriptMgr->OnAuctionExpire(this, auction);
         }
         ///- Or perform the transaction
@@ -465,7 +467,9 @@ void AuctionHouseObject::Update()
             //we should send an "item sold" message if the seller is online
             //we send the item to the winner
             //we send the money to the seller
-            sAuctionMgr->SendAuctionSuccessfulMail(auction, trans);
+            if (auction->owner != sWorld->getIntConfig(CONFIG_AHBOT_SELL_OWNER))
+                sAuctionMgr->SendAuctionSuccessfulMail(auction, trans);
+
             sAuctionMgr->SendAuctionWonMail(auction, trans);
             sScriptMgr->OnAuctionSuccessful(this, auction);
         }
@@ -763,12 +767,15 @@ void AuctionHouseMgr::DeleteExpiredAuctionsAtStartup()
         if (auction->bidder==0)
         {
             // Cancel the auction, there was no bidder
-            sAuctionMgr->SendAuctionExpiredMail(auction, trans);
+            if (auction->owner != sWorld->getIntConfig(CONFIG_AHBOT_SELL_OWNER))
+                sAuctionMgr->SendAuctionExpiredMail(auction, trans);
         }
         else
         {
             // Send the item to the winner and money to seller
-            sAuctionMgr->SendAuctionSuccessfulMail(auction, trans);
+            if (auction->owner != sWorld->getIntConfig(CONFIG_AHBOT_SELL_OWNER))
+                sAuctionMgr->SendAuctionSuccessfulMail(auction, trans);
+
             sAuctionMgr->SendAuctionWonMail(auction, trans);
         }
 
diff --git a/src/server/game/AuctionHouseBot/AuctionHouseBot.cpp b/src/server/game/AuctionHouseBot/AuctionHouseBot.cpp
index 6bf5fa0..911f235 100644
--- a/src/server/game/AuctionHouseBot/AuctionHouseBot.cpp
+++ b/src/server/game/AuctionHouseBot/AuctionHouseBot.cpp
@@ -225,6 +225,12 @@ void AuctionBotConfig::GetConfigFromFile()
     SetConfig(CONFIG_AHBOT_CLASS_TRADEGOOD_MAX_ITEM_LEVEL, "AuctionHouseBot.Class.TradeGood.ItemLevel.Max", 0);
     SetConfig(CONFIG_AHBOT_CLASS_CONTAINER_MIN_ITEM_LEVEL, "AuctionHouseBot.Class.Container.ItemLevel.Min", 0);
     SetConfig(CONFIG_AHBOT_CLASS_CONTAINER_MAX_ITEM_LEVEL, "AuctionHouseBot.Class.Container.ItemLevel.Max", 0);
+
+    SetConfig(CONFIG_AHBOT_OWNER, "AuctionHouseBot.Owner", 0);
+    SetConfig(CONFIG_AHBOT_MAX_GLYPH_STACK, "AuctionHouseBot.Max.Glyph.Stack", 1);
+    SetConfig(CONFIG_AHBOT_MAX_GREEN_STACK, "AuctionHouseBot.Max.Green.Stack", 0);
+    SetConfig(CONFIG_AHBOT_MAX_BLUE_STACK, "AuctionHouseBot.Max.Blue.Stack", 0);
+    SetConfig(CONFIG_AHBOT_MAX_EPIC_STACK, "AuctionHouseBot.Max.Epic.Stack", 0);
 }
 
 char const* AuctionBotConfig::GetHouseTypeName(AuctionHouseType houseType)
diff --git a/src/server/game/AuctionHouseBot/AuctionHouseBot.h b/src/server/game/AuctionHouseBot/AuctionHouseBot.h
index 04ca96d..36519c3 100644
--- a/src/server/game/AuctionHouseBot/AuctionHouseBot.h
+++ b/src/server/game/AuctionHouseBot/AuctionHouseBot.h
@@ -126,6 +126,11 @@ enum AuctionBotConfigUInt32Values
     CONFIG_AHBOT_CLASS_TRADEGOOD_MAX_ITEM_LEVEL,
     CONFIG_AHBOT_CLASS_CONTAINER_MIN_ITEM_LEVEL,
     CONFIG_AHBOT_CLASS_CONTAINER_MAX_ITEM_LEVEL,
+    CONFIG_AHBOT_OWNER,
+    CONFIG_AHBOT_MAX_GLYPH_STACK,
+    CONFIG_AHBOT_MAX_GREEN_STACK,
+    CONFIG_AHBOT_MAX_BLUE_STACK,
+    CONFIG_AHBOT_MAX_EPIC_STACK,
     CONFIG_UINT32_AHBOT_UINT32_COUNT
 };
 
diff --git a/src/server/game/AuctionHouseBot/AuctionHouseBotSeller.cpp b/src/server/game/AuctionHouseBot/AuctionHouseBotSeller.cpp
index 13aa1f2..e66c6e1 100644
--- a/src/server/game/AuctionHouseBot/AuctionHouseBotSeller.cpp
+++ b/src/server/game/AuctionHouseBot/AuctionHouseBotSeller.cpp
@@ -622,7 +622,7 @@ uint32 AuctionBotSeller::SetStat(SellerConfiguration& config)
         {
             ItemTemplate const* prototype = item->GetTemplate();
             if (prototype)
-                if (!auctionEntry->owner)                         // Add only ahbot items
+                if (auctionEntry->owner == sAuctionBotConfig->GetConfig(CONFIG_AHBOT_OWNER))                          // Add only ahbot items
                     ++itemsSaved[prototype->Quality][prototype->Class];
         }
     }
@@ -949,7 +949,33 @@ void AuctionBotSeller::AddNewAuctions(SellerConfiguration& config)
             continue;
         }
 
-        uint32 stackCount = urand(1, prototype->GetMaxStackSize());
+        uint32 mStack;
+        // arrow & bullet
+        if (prototype->Class == 6 && (prototype->SubClass == 2 || prototype->SubClass == 3))
+        {
+            mStack = prototype->GetMaxStackSize();
+        }
+        else
+        {
+            switch (prototype->Quality) {
+            case 1:
+                mStack = prototype->Class == 16 ? sAuctionBotConfig->GetConfig(CONFIG_AHBOT_MAX_GLYPH_STACK) : prototype->GetMaxStackSize();
+                break;
+            case 2:
+                mStack = sAuctionBotConfig->GetConfig(CONFIG_AHBOT_MAX_GREEN_STACK);
+                break;
+            case 3:
+                mStack = sAuctionBotConfig->GetConfig(CONFIG_AHBOT_MAX_BLUE_STACK);
+                break;
+            case 4:
+                mStack = sAuctionBotConfig->GetConfig(CONFIG_AHBOT_MAX_EPIC_STACK);
+                break;
+            default:
+                mStack = prototype->GetMaxStackSize();
+            }
+        }
+
+        uint32 stackCount = urand(1, mStack ? mStack : prototype->GetMaxStackSize());
 
         Item* item = Item::CreateItem(itemId, stackCount);
         if (!item)
@@ -989,7 +1015,7 @@ void AuctionBotSeller::AddNewAuctions(SellerConfiguration& config)
 
         AuctionEntry* auctionEntry = new AuctionEntry();
         auctionEntry->Id = sObjectMgr->GenerateAuctionID();
-        auctionEntry->owner = 0;
+        auctionEntry->owner = sAuctionBotConfig->GetConfig(CONFIG_AHBOT_OWNER);
         auctionEntry->itemGUIDLow = item->GetGUIDLow();
         auctionEntry->itemEntry = item->GetEntry();
         auctionEntry->startbid = bidPrice;
diff --git a/src/server/game/Handlers/AuctionHouseHandler.cpp b/src/server/game/Handlers/AuctionHouseHandler.cpp
index 86fa042..e6dfa6b 100644
--- a/src/server/game/Handlers/AuctionHouseHandler.cpp
+++ b/src/server/game/Handlers/AuctionHouseHandler.cpp
@@ -491,8 +491,11 @@ void WorldSession::HandleAuctionPlaceBid(WorldPacket& recvData)
         GetPlayer()->UpdateAchievementCriteria(ACHIEVEMENT_CRITERIA_TYPE_HIGHEST_AUCTION_BID, auction->buyout);
 
         //- Mails must be under transaction control too to prevent data loss
-        sAuctionMgr->SendAuctionSalePendingMail(auction, trans);
-        sAuctionMgr->SendAuctionSuccessfulMail(auction, trans);
+        if (auction->owner != sWorld->getIntConfig(CONFIG_AHBOT_SELL_OWNER))
+        {
+            sAuctionMgr->SendAuctionSalePendingMail(auction, trans);
+            sAuctionMgr->SendAuctionSuccessfulMail(auction, trans);
+        }
         sAuctionMgr->SendAuctionWonMail(auction, trans);
 
         SendAuctionCommandResult(auction->Id, AUCTION_PLACE_BID, ERR_AUCTION_OK);
@@ -537,29 +540,20 @@ void WorldSession::HandleAuctionRemoveItem(WorldPacket& recvData)
     SQLTransaction trans = CharacterDatabase.BeginTransaction();
     if (auction && auction->owner == player->GetGUIDLow())
     {
-        Item* pItem = sAuctionMgr->GetAItem(auction->itemGUIDLow);
-        if (pItem)
+        if (sWorld->getIntConfig(CONFIG_AHBOT_SELL_OWNER) != auction->owner)
         {
-            if (auction->bidder > 0)                        // If we have a bidder, we have to send him the money he paid
+            Item* pItem = sAuctionMgr->GetAItem(auction->itemGUIDLow);
+            if (pItem)
             {
-                uint32 auctionCut = auction->GetAuctionCut();
-                if (!player->HasEnoughMoney(auctionCut))          //player doesn't have enough money, maybe message needed
-                    return;
-                //some auctionBidderNotification would be needed, but don't know that parts..
-                sAuctionMgr->SendAuctionCancelledToBidderMail(auction, trans);
-                player->ModifyMoney(-int32(auctionCut));
-            }
-
-            // item will deleted or added to received mail list
-            MailDraft(auction->BuildAuctionMailSubject(AUCTION_CANCELED), AuctionEntry::BuildAuctionMailBody(0, 0, auction->buyout, auction->deposit, 0))
-                .AddItem(pItem)
-                .SendMailTo(trans, player, auction, MAIL_CHECK_MASK_COPIED);
-        }
-        else
-        {
-            TC_LOG_ERROR("network", "Auction id: %u has non-existed item (item guid : %u)!!!", auction->Id, auction->itemGUIDLow);
-            SendAuctionCommandResult(0, AUCTION_CANCEL, ERR_AUCTION_DATABASE_ERROR);
-            return;
+                if (auction->bidder > 0)                        // If we have a bidder, we have to send him the money he paid
+                {
+                    uint32 auctionCut = auction->GetAuctionCut();
+                    if (!player->HasEnoughMoney(auctionCut))          //player doesn't have enough money, maybe message needed
+                        return;
+                    //some auctionBidderNotification would be needed, but don't know that parts..
+                    sAuctionMgr->SendAuctionCancelledToBidderMail(auction, trans);
+                    player->ModifyMoney(-int32(auctionCut));
+                }
         }
     }
     else
diff --git a/src/server/game/World/World.cpp b/src/server/game/World/World.cpp
index ebc3f32..13abfbc 100644
--- a/src/server/game/World/World.cpp
+++ b/src/server/game/World/World.cpp
@@ -1290,6 +1290,8 @@ void World::LoadConfigSettings(bool reload)
     // AHBot
     m_int_configs[CONFIG_AHBOT_UPDATE_INTERVAL] = sConfigMgr->GetIntDefault("AuctionHouseBot.Update.Interval", 20);
 
+    m_int_configs[CONFIG_AHBOT_SELL_OWNER] = sConfigMgr->GetIntDefault("AuctionHouseBot.Owner", 0);
+
     // call ScriptMgr if we're reloading the configuration
     if (reload)
         sScriptMgr->OnConfigLoad(reload);
diff --git a/src/server/game/World/World.h b/src/server/game/World/World.h
index af9eead..3f29e00 100644
--- a/src/server/game/World/World.h
+++ b/src/server/game/World/World.h
@@ -389,6 +389,7 @@ enum WorldIntConfigs
     CONFIG_BIRTHDAY_TIME,
     CONFIG_CREATURE_PICKPOCKET_REFILL,
     CONFIG_AHBOT_UPDATE_INTERVAL,
+    CONFIG_AHBOT_SELL_OWNER,
     INT_CONFIG_VALUE_COUNT
 };
 
diff --git a/src/server/worldserver/worldserver.conf.dist b/src/server/worldserver/worldserver.conf.dist
index a154eaf..d6bb4fb 100644
--- a/src/server/worldserver/worldserver.conf.dist
+++ b/src/server/worldserver/worldserver.conf.dist
@@ -2931,6 +2931,40 @@ AuctionHouseBot.Class.Key = 1
 AuctionHouseBot.Class.Misc = 5
 AuctionHouseBot.Class.Glyph = 3
 
+###################################################################################################
+#
+# AHBot Patch
+AuctionHouseBot.Owner = 0
+
+AuctionHouseBot.Max.Glyph.Stack = 1
+AuctionHouseBot.Max.Green.Stack = 0
+AuctionHouseBot.Max.Blue.Stack  = 0
+AuctionHouseBot.Max.Epic.Stack  = 0
+
+AuctionHouseBot.Items.Gray.Price.Ratio       = 100
+AuctionHouseBot.Items.White.Price.Ratio      = 100
+AuctionHouseBot.Items.Green.Price.Ratio      = 100
+AuctionHouseBot.Items.Blue.Price.Ratio       = 100
+AuctionHouseBot.Items.Purple.Price.Ratio     = 100
+AuctionHouseBot.Items.Orange.Price.Ratio     = 100
+AuctionHouseBot.Items.Yellow.Price.Ratio     = 100
+
+AuctionHouseBot.Class.Consumable.Price.Ratio = 100
+AuctionHouseBot.Class.Container.Price.Ratio  = 100
+AuctionHouseBot.Class.Weapon.Price.Ratio     = 100
+AuctionHouseBot.Class.Gem.Price.Ratio        = 100
+AuctionHouseBot.Class.Armor.Price.Ratio      = 100
+AuctionHouseBot.Class.Reagent.Price.Ratio    = 100
+AuctionHouseBot.Class.Projectile.Price.Ratio = 100
+AuctionHouseBot.Class.TradeGood.Price.Ratio  = 100
+AuctionHouseBot.Class.Generic.Price.Ratio    = 100
+AuctionHouseBot.Class.Recipe.Price.Ratio     = 100
+AuctionHouseBot.Class.Quiver.Price.Ratio     = 100
+AuctionHouseBot.Class.Quest.Price.Ratio      = 100
+AuctionHouseBot.Class.Key.Price.Ratio        = 100
+AuctionHouseBot.Class.Misc.Price.Ratio       = 100
+AuctionHouseBot.Class.Glyph.Price.Ratio      = 100
+
 #
 ###################################################################################################
 
-- 
1.8.3.msysgit.0