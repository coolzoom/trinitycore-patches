From 7ef9632f861693a5bc6dea2982c3a10a7701be94 Mon Sep 17 00:00:00 2001
From: LordPsyan <realmsofwarcraft@gmail.com>
Date: Fri, 22 Aug 2014 10:24:09 -0400
Subject: [PATCH] LevelNPC

---
 npc-entry-list.txt                                 |   2 +
 .../LevelNPC/world.levelnpc.sql                    |   3 +
 src/server/game/Scripting/ScriptLoader.cpp         |   6 +-
 src/server/scripts/Custom/CMakeLists.txt           |   4 +-
 src/server/scripts/Custom/levelnpc.cpp             | 192 +++++++++++++++++++++
 5 files changed, 203 insertions(+), 4 deletions(-)
 create mode 100644 npc-entry-list.txt
 create mode 100644 sql/TrinityCore-Patches/LevelNPC/world.levelnpc.sql
 create mode 100644 src/server/scripts/Custom/levelnpc.cpp

diff --git a/npc-entry-list.txt b/npc-entry-list.txt
new file mode 100644
index 0000000..a8f9600
--- /dev/null
+++ b/npc-entry-list.txt
@@ -0,0 +1,2 @@
+LevelNPC
+60003 - Lucy
\ No newline at end of file
diff --git a/sql/TrinityCore-Patches/LevelNPC/world.levelnpc.sql b/sql/TrinityCore-Patches/LevelNPC/world.levelnpc.sql
new file mode 100644
index 0000000..1ed9694
--- /dev/null
+++ b/sql/TrinityCore-Patches/LevelNPC/world.levelnpc.sql
@@ -0,0 +1,3 @@
+-- Creature_template entry. Make sure entry number does not conflict.
+INSERT INTO `creature_template` (`entry`, `difficulty_entry_1`, `difficulty_entry_2`, `difficulty_entry_3`, `KillCredit1`, `KillCredit2`, `modelid1`, `modelid2`, `modelid3`, `modelid4`, `name`, `subname`, `IconName`, `gossip_menu_id`, `minlevel`, `maxlevel`, `exp`, `faction`, `npcflag`, `speed_walk`, `speed_run`, `scale`, `rank`, `mindmg`, `maxdmg`, `dmgschool`, `attackpower`, `dmg_multiplier`, `baseattacktime`, `rangeattacktime`, `unit_class`, `unit_flags`, `unit_flags2`, `dynamicflags`, `family`, `trainer_type`, `trainer_spell`, `trainer_class`, `trainer_race`, `minrangedmg`, `maxrangedmg`, `rangedattackpower`, `type`, `type_flags`, `lootid`, `pickpocketloot`, `skinloot`, `resistance1`, `resistance2`, `resistance3`, `resistance4`, `resistance5`, `resistance6`, `spell1`, `spell2`, `spell3`, `spell4`, `spell5`, `spell6`, `spell7`, `spell8`, `PetSpellDataId`, `VehicleId`, `mingold`, `maxgold`, `AIName`, `MovementType`, `InhabitType`, `HoverHeight`, `Health_mod`, `Mana_mod`, `Armor_mod`, `RacialLeader`, `questItem1`, `questItem2`, `questItem3`, `questItem4`, `questItem5`, `questItem6`, `movementId`, `RegenHealth`, `mechanic_immune_mask`, `flags_extra`, `ScriptName`, `VerifiedBuild`) VALUES
+('60003','0','0','0','0','0','2591','0','0','0','Lucy','Level NPC','','0','80','80','0','35','1','1','1.14286','1','1','1755','1755','0','1504','1','1500','0','1','0','2048','0','0','0','0','0','0','0','0','0','7','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','EventAI','0','3','1','1','1','1','0','0','0','0','0','0','0','0','1','0','0','levelnpc','0');
\ No newline at end of file
diff --git a/src/server/game/Scripting/ScriptLoader.cpp b/src/server/game/Scripting/ScriptLoader.cpp
index d036d43..c57c98f 100644
--- a/src/server/game/Scripting/ScriptLoader.cpp
+++ b/src/server/game/Scripting/ScriptLoader.cpp
@@ -1432,13 +1432,15 @@ void AddBattlegroundScripts()
 
 #ifdef SCRIPTS
 /* This is where custom scripts' loading functions should be declared. */
-
+// Level NPC
+void AddSC_levelnpc();
 #endif
 
 void AddCustomScripts()
 {
 #ifdef SCRIPTS
     /* This is where custom scripts should be added. */
-
+    // Level NPC
+    AddSC_levelnpc();
 #endif
 }
diff --git a/src/server/scripts/Custom/CMakeLists.txt b/src/server/scripts/Custom/CMakeLists.txt
index 80ebe36..20c2bc9 100644
--- a/src/server/scripts/Custom/CMakeLists.txt
+++ b/src/server/scripts/Custom/CMakeLists.txt
@@ -8,11 +8,11 @@
 # WITHOUT ANY WARRANTY, to the extent permitted by law; without even the
 # implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 
-# file(GLOB_RECURSE sources_Custom Custom/*.cpp Custom/*.h)
+file(GLOB_RECURSE sources_Custom Custom/*.cpp Custom/*.h)
 
 set(scripts_STAT_SRCS
   ${scripts_STAT_SRCS}
-#  ${sources_Custom}
+  ${sources_Custom}
 )
 
 message("  -> Prepared: Custom")
diff --git a/src/server/scripts/Custom/levelnpc.cpp b/src/server/scripts/Custom/levelnpc.cpp
new file mode 100644
index 0000000..20b4331
--- /dev/null
+++ b/src/server/scripts/Custom/levelnpc.cpp
@@ -0,0 +1,192 @@
+/* Copyright (C) 2006 - 2009 ScriptDev2 <https://scriptdev2.svn.sourceforge.net/>
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License as published by
+ * the Free Software Foundation; either version 2 of the License, or
+ * (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+ *
+ * Created by LordPsyan for Flaminglegion.net
+ *
+ */
+
+#include "ScriptPCH.h"
+#include "Config.h"
+
+#define GOSSIP_SENDER_MAIN      1000
+#define SPELL_RESURRECTION_SICKNESS_15007  15007
+
+class levelnpc : public CreatureScript
+{
+public:
+    levelnpc() : CreatureScript("levelnpc") {}
+
+
+bool OnGossipHello(Player* pPlayer, Creature* pCreature)
+{
+    if(sConfigMgr->GetBoolDefault("LevelNPC.OnlyGMs", false)) // If LevelNPC.OnlyGMs is enabled in trinitycore.conf
+        if (pPlayer->GetSession()->GetSecurity() == SEC_PLAYER)
+        {
+            pCreature->MonsterWhisper("Sorry, I can only add levels to Platinum Members.", pPlayer);
+            return true;
+        }
+
+    bool EnableLevel80 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel80", true);
+    bool EnableLevel100 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel100", true);
+    bool EnableLevel150 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel150", true);
+    bool EnableLevel200 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel200", true);
+    bool EnableLevel255 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel255", true);
+    if (pPlayer->GetTeam() == ALLIANCE)
+    {
+        pPlayer->ADD_GOSSIP_ITEM( 7, "Instant Levels ->"        , GOSSIP_SENDER_MAIN, 1000);
+        pPlayer->ADD_GOSSIP_ITEM( 10, "Remove Resurrect Sickness" , GOSSIP_SENDER_MAIN, 5000);
+    }
+    else
+    {
+        pPlayer->ADD_GOSSIP_ITEM( 7, "Instant Levels ->"        , GOSSIP_SENDER_MAIN, 1000);
+        pPlayer->ADD_GOSSIP_ITEM( 10, "Remove Resurrect Sickness" , GOSSIP_SENDER_MAIN, 5000);
+    }
+    pPlayer->SEND_GOSSIP_MENU(DEFAULT_GOSSIP_MESSAGE,pCreature->GetGUID());
+
+return true;
+}
+
+void SendDefaultMenu(Player* pPlayer, Creature* pCreature, uint32 uiAction)
+{
+
+// Not allow in combat
+if (pPlayer->IsInCombat())
+{
+    pPlayer->CLOSE_GOSSIP_MENU();
+    pCreature->MonsterSay("You are in combat!", LANG_UNIVERSAL, NULL);
+    return;
+}
+
+    bool EnableLevel80 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel80", true);
+    bool EnableLevel100 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel100", true);
+    bool EnableLevel150 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel150", true);
+    bool EnableLevel200 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel200", true);
+    bool EnableLevel255 = sConfigMgr->GetBoolDefault("LevelNPC.EnableLevel255", true);
+
+//Mony Check
+if(sConfigMgr->GetBoolDefault("LevelNPC.UseTokens", true))
+{
+if (!pPlayer->HasItemCount((sConfigMgr->GetIntDefault("LevelNPC.ItemEntryNum",0)), 0))
+{
+    pPlayer->CLOSE_GOSSIP_MENU();
+    pCreature->MonsterWhisper("You ain't gots no darn chips.", pPlayer);
+    return;
+}
+}
+else if(pPlayer->GetMoney() < (sConfigMgr->GetIntDefault("LevelNPC.SkillGoldCost",0)))
+{
+    pPlayer->CLOSE_GOSSIP_MENU();
+    pCreature->MonsterWhisper("You don't have enough money.", pPlayer);
+    return;
+}
+
+switch(uiAction)
+{
+
+//////////////////////////////////////////////////Leveling///////////////////////////////////////////////////////////////
+case 1000: //Leveling
+    if(EnableLevel80 && pPlayer->getLevel() < 80)
+        pPlayer->ADD_GOSSIP_ITEM( 7, "(1 Donation Chip) Instant 80 ->"         , GOSSIP_SENDER_MAIN, 1001);
+    if(EnableLevel100 && pPlayer->getLevel() < 100 && pPlayer->getLevel() >= 80)
+        pPlayer->ADD_GOSSIP_ITEM( 7, "(2 Donation Chips) Instant 100 ->"        , GOSSIP_SENDER_MAIN, 1002);
+    if(EnableLevel150 && pPlayer->getLevel() < 150 && pPlayer->getLevel() >= 100)
+        pPlayer->ADD_GOSSIP_ITEM( 7, "(5 Donation Chips) Instant 150 ->"        , GOSSIP_SENDER_MAIN, 1003);
+    if(EnableLevel200 && pPlayer->getLevel() < 200 && pPlayer->getLevel() >= 150)
+        pPlayer->ADD_GOSSIP_ITEM( 7, "(10 Donation Chips) Instant 200 ->"       , GOSSIP_SENDER_MAIN, 1004);
+    if(EnableLevel255 && pPlayer->getLevel() < 255 && pPlayer->getLevel() >= 200)
+        pPlayer->ADD_GOSSIP_ITEM( 7, "(20 Donation Chips) Instant 255 ->"       , GOSSIP_SENDER_MAIN, 1005);
+        pPlayer->ADD_GOSSIP_ITEM( 7, "<- Main Menu"                       , GOSSIP_SENDER_MAIN, 3000);
+    pPlayer->SEND_GOSSIP_MENU(DEFAULT_GOSSIP_MESSAGE,pCreature->GetGUID());
+break;
+case 3000: //Leveling
+    if(EnableLevel80)
+        pPlayer->ADD_GOSSIP_ITEM( 7, "Instant Levels ->"        , GOSSIP_SENDER_MAIN, 1000);
+    pPlayer->SEND_GOSSIP_MENU(DEFAULT_GOSSIP_MESSAGE,pCreature->GetGUID());
+break;
+case 1001: // Leveling
+    pPlayer->GiveLevel(80);
+    if(sConfigMgr->GetBoolDefault("LevelNPC.UseTokens", true))
+    pPlayer->DestroyItemCount(99998, 1, true);
+    else
+    pPlayer->ModifyMoney(-(sConfigMgr->GetIntDefault("LevelNPC.SkillGoldCost",0)));
+    pPlayer->CLOSE_GOSSIP_MENU();
+break;
+case 1002: // Leveling
+    pPlayer->GiveLevel(100);
+    if(sConfigMgr->GetBoolDefault("LevelNPC.UseTokens", true))
+    pPlayer->DestroyItemCount(99998, 2, true);
+    else
+    pPlayer->ModifyMoney(-(sConfigMgr->GetIntDefault("LevelNPC.SkillGoldCost",0)));
+    pPlayer->CLOSE_GOSSIP_MENU();
+break;
+case 1003: // Leveling
+    pPlayer->GiveLevel(150);
+    if(sConfigMgr->GetBoolDefault("LevelNPC.UseTokens", true))
+    pPlayer->DestroyItemCount(99998, 5, true);
+    else
+    pPlayer->ModifyMoney(-(sConfigMgr->GetIntDefault("LevelNPC.SkillGoldCost",0)));
+    pPlayer->CLOSE_GOSSIP_MENU();
+break;
+case 1004: // Leveling
+    pPlayer->GiveLevel(200);
+    if(sConfigMgr->GetBoolDefault("LevelNPC.UseTokens", true))
+    pPlayer->DestroyItemCount(99998, 10, true);
+    else
+    pPlayer->ModifyMoney(-(sConfigMgr->GetIntDefault("LevelNPC.SkillGoldCost",0)));
+    pPlayer->CLOSE_GOSSIP_MENU();
+break;
+case 1005: // Leveling
+    pPlayer->GiveLevel(255);
+    if(sConfigMgr->GetBoolDefault("LevelNPC.UseTokens", true))
+    pPlayer->DestroyItemCount(99998, 20, true);
+    else
+    pPlayer->ModifyMoney(-(sConfigMgr->GetIntDefault("LevelNPC.SkillGoldCost",0)));
+    pPlayer->CLOSE_GOSSIP_MENU();
+break;
+case 5000://Remove Res Sickness
+    if(!pPlayer->HasAura(SPELL_RESURRECTION_SICKNESS_15007,0))
+    {
+        pCreature->MonsterWhisper("You don't have resurrection sickness.", pPlayer);
+        OnGossipHello(pPlayer, pCreature);
+        return;
+    }
+
+    pCreature->CastSpell(pPlayer,38588,false); // Healing effect
+    pPlayer->RemoveAurasDueToSpell(SPELL_RESURRECTION_SICKNESS_15007,0);
+    pPlayer->CLOSE_GOSSIP_MENU();
+break;
+
+ pPlayer->CLOSE_GOSSIP_MENU();
+
+} // end of switch
+} //end of function
+
+bool OnGossipSelect(Player* pPlayer, Creature* pCreature, uint32 uiSender, uint32 uiAction)
+{
+    // Main menu
+    pPlayer->PlayerTalkClass->ClearMenus();
+    if (uiSender == GOSSIP_SENDER_MAIN)
+    SendDefaultMenu(pPlayer, pCreature, uiAction);
+
+return true;
+}
+};
+
+void AddSC_levelnpc()
+{
+
+new levelnpc();
+
+}
-- 
2.1.0.rc1

