From 28a55dc6542493c0acda556fcd9646b7b6a6c544 Mon Sep 17 00:00:00 2001
From: LordPsyan <realmsofwarcraft@gmail.com>
Date: Thu, 28 Aug 2014 14:31:46 -0400
Subject: [PATCH] 434_prepatch

---
 npc-entry-list.txt                                 |  24 +++
 src/server/game/Accounts/RBAC.h                    |  24 +++
 src/server/game/Entities/Player/Player.cpp         |  25 ++++
 src/server/game/Handlers/CharacterHandler.cpp      |  50 ++++++-
 src/server/game/Miscellaneous/Formulas.h           |  30 +++-
 src/server/game/Miscellaneous/Language.h           |  26 +++-
 src/server/game/Scripting/ScriptLoader.cpp         | 162 ++++++++++++++++++++-
 src/server/scripts/Custom/CMakeLists.txt           |   4 +-
 .../Database/Implementation/CharacterDatabase.cpp  |  24 +++
 .../Database/Implementation/CharacterDatabase.h    |  25 +++-
 src/server/worldserver/worldserver.conf.dist       |  27 ++++
 11 files changed, 412 insertions(+), 9 deletions(-)
 create mode 100644 npc-entry-list.txt

diff --git a/npc-entry-list.txt b/npc-entry-list.txt
new file mode 100644
index 0000000..4090a23
--- /dev/null
+++ b/npc-entry-list.txt
@@ -0,0 +1,24 @@
+This is a list of all NPC's used in all of the patches.
+
+All-In-One NPC
+80000 - Young Woman
+Arena Gambler
+908001 - The Lich King
+BeastMaster
+99990 - LordPsyan
+Guild Houses
+13 - Beltez
+TeleNPC
+100000 - Abyssal Vortex
+NPC Buff
+60002 - LordPsyan
+Enchant:
+100067 - Young Woman
+Profession NPC
+60001 - Cyon
+Level NPC
+60003 - Lucy
+Reforging
+190011 - Thaumaturge Vashreen
+Transmogrification
+190010 - Warpweaver
\ No newline at end of file
diff --git a/src/server/game/Accounts/RBAC.h b/src/server/game/Accounts/RBAC.h
index 25f7edd..cd824cd 100644
--- a/src/server/game/Accounts/RBAC.h
+++ b/src/server/game/Accounts/RBAC.h
@@ -683,6 +683,30 @@ enum RBACPermissions
     RBAC_PERM_COMMAND_MAILBOX                                = 777,
 
     // custom permissions 1000+
+    // Prepatch by LordPsyan
+    // 01
+    // 02
+    // 03
+    // 04
+    // 05
+    // 06
+    // 07
+    // 08
+    // 09
+    // 10
+    // 11
+    // 12
+    // 13
+    // 14
+    // 15
+    // 16
+    // 17
+    // 18
+    // 19
+    // 20
+    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+    //
+    // End of prepatch
     RBAC_PERM_MAX
 };
 
diff --git a/src/server/game/Entities/Player/Player.cpp b/src/server/game/Entities/Player/Player.cpp
index d9c92d0..9f382a3 100644
--- a/src/server/game/Entities/Player/Player.cpp
+++ b/src/server/game/Entities/Player/Player.cpp
@@ -81,6 +81,7 @@
 #include "WorldSession.h"
 #include "MovementStructures.h"
 #include "GameObjectAI.h"
+#include "Config.h"
 
 #define ZONE_UPDATE_INTERVAL (1*IN_MILLISECONDS)
 
@@ -12386,6 +12387,30 @@ void Player::MoveItemFromInventory(uint8 bag, uint8 slot, bool update)
 {
     if (Item* it = GetItemByPos(bag, slot))
     {
+    // Prepatch by LordPsyan
+    // 01
+    // 02
+    // 03
+    // 04
+    // 05
+    // 06
+    // 07
+    // 08
+    // 09
+    // 10
+    // 11
+    // 12
+    // 13
+    // 14
+    // 15
+    // 16
+    // 17
+    // 18
+    // 19
+    // 20
+    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+    //
+    // End of prepatch
         ItemRemovedQuestCheck(it->GetEntry(), it->GetCount());
         RemoveItem(bag, slot, update);
         it->SetNotRefundable(this, false);
diff --git a/src/server/game/Handlers/CharacterHandler.cpp b/src/server/game/Handlers/CharacterHandler.cpp
index 422e5ce..a5d3fa3 100644
--- a/src/server/game/Handlers/CharacterHandler.cpp
+++ b/src/server/game/Handlers/CharacterHandler.cpp
@@ -1138,10 +1138,56 @@ void WorldSession::HandlePlayerLogin(LoginQueryHolder* holder)
     _player->UpdateAchievementCriteria(ACHIEVEMENT_CRITERIA_TYPE_ON_LOGIN, 1);
 
     sScriptMgr->OnPlayerLogin(pCurrChar, firstLogin);
-
+    // Prepatch by LordPsyan
+    // 01
+    // 02
+    // 03
+    // 04
+    // 05
+    // 06
+    // 07
+    // 08
+    // 09
+    // 10
+    // 11
+    // 12
+    // 13
+    // 14
+    // 15
+    // 16
+    // 17
+    // 18
+    // 19
+    // 20
+    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+    //
+    // End of prepatch
     delete holder;
 }
-
+    // Prepatch by LordPsyan
+    // 01
+    // 02
+    // 03
+    // 04
+    // 05
+    // 06
+    // 07
+    // 08
+    // 09
+    // 10
+    // 11
+    // 12
+    // 13
+    // 14
+    // 15
+    // 16
+    // 17
+    // 18
+    // 19
+    // 20
+    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+    //
+    // End of prepatch
 void WorldSession::HandleSetFactionAtWar(WorldPacket& recvData)
 {
     TC_LOG_DEBUG("network", "WORLD: Received CMSG_SET_FACTION_ATWAR");
diff --git a/src/server/game/Miscellaneous/Formulas.h b/src/server/game/Miscellaneous/Formulas.h
index 537fa75..24ff516 100644
--- a/src/server/game/Miscellaneous/Formulas.h
+++ b/src/server/game/Miscellaneous/Formulas.h
@@ -23,6 +23,7 @@
 #include "SharedDefines.h"
 #include "ScriptMgr.h"
 #include "Player.h"
+#include "Config.h"
 
 namespace Trinity
 {
@@ -186,9 +187,36 @@ namespace Trinity
 
                     xpMod *= creature->GetCreatureTemplate()->ModExperience;
                 }
-
+            if(sConfigMgr->GetBoolDefault("PrepatchGI.Added", false))
+                {
+                    // Prepatch by LordPsyan
+                    // 01
+                    // 02
+                    // 03
+                    // 04
+                    // 05
+                    // 06
+                    // 07
+                    // 08
+                    // 09
+                    // 10
+                    // 11
+                    // 12
+                    // 13
+                    // 14
+                    // 15
+                    // 16
+                    // 17
+                    // 18
+                    // 19
+                    // 20
+                    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+                    //
+                    // End of prepatch
+                } else {
                 xpMod *= sWorld->getRate(RATE_XP_KILL);
                 gain = uint32(gain * xpMod);
+                }
             }
 
             sScriptMgr->OnGainCalculation(gain, player, u);
diff --git a/src/server/game/Miscellaneous/Language.h b/src/server/game/Miscellaneous/Language.h
index 0f917f4..60b0fe6 100644
--- a/src/server/game/Miscellaneous/Language.h
+++ b/src/server/game/Miscellaneous/Language.h
@@ -1181,7 +1181,31 @@ enum TrinityStrings
     LANG_BAN_ACCOUNT_YOUPERMBANNEDMESSAGE_WORLD   = 11007,
 
     LANG_NPCINFO_INHABIT_TYPE                     = 11008,
-    LANG_NPCINFO_FLAGS_EXTRA                      = 11009
+    LANG_NPCINFO_FLAGS_EXTRA                      = 11009,
+    // Prepatch by LordPsyan
+    // 01
+    // 02
+    // 03
+    // 04
+    // 05
+    // 06
+    // 07
+    // 08
+    // 09
+    // 10
+    // 11
+    // 12
+    // 13
+    // 14
+    // 15
+    // 16
+    // 17
+    // 18
+    // 19
+    // 20
+    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+    //
+    // End of prepatch
 
     // NOT RESERVED IDS                   12000-1999999999
     // `db_script_string` table index     2000000000-2000009999 (MIN_DB_SCRIPT_STRING_ID-MAX_DB_SCRIPT_STRING_ID)
diff --git a/src/server/game/Scripting/ScriptLoader.cpp b/src/server/game/Scripting/ScriptLoader.cpp
index 9bdf591..ae94944 100644
--- a/src/server/game/Scripting/ScriptLoader.cpp
+++ b/src/server/game/Scripting/ScriptLoader.cpp
@@ -1455,13 +1455,171 @@ void AddBattlegroundScripts()
 
 #ifdef SCRIPTS
 /* This is where custom scripts' loading functions should be declared. */
-
+// start01
+// start02
+// start03
+// start04
+// start05
+// start06
+// start07
+// start08
+// start09
+// start10
+// start11
+// start12
+// start13
+// start14
+// start15
+// start16
+// start17
+// start18
+// start19
+// start20
+// start21
+// start22
+// start23
+// start24
+// start25
+// start26
+// start27
+// start28
+// start29
+// start30
+// start31
+// start32
+// start33
+// start34
+// start35
+// start36
+// start37
+// start38
+// start39
+// start40
+// start41
+// start42
+// start43
+// start44
+// start45
+// start46
+// start47
+// start48
+// start49
+// start50
+// start51
+// start52
+// start53
+// start54
+// start55
+// start56
+// start57
+// start58
+// start59
+// start60
+// start61
+// start62
+// start63
+// start64
+// start65
+// start66
+// start67
+// start68
+// start69
+// start70
+// start71
+// start72
+// start73
+// start74
+// start75
+// start76
+// start77
+// start78
+// start79
+// start80
 #endif
 
 void AddCustomScripts()
 {
 #ifdef SCRIPTS
     /* This is where custom scripts should be added. */
-
+// end01
+// end02
+// end03
+// end04
+// end05
+// end06
+// end07
+// end08
+// end09
+// end10
+// end11
+// end12
+// end13
+// end14
+// end15
+// end16
+// end17
+// end18
+// end19
+// end20
+// end21
+// end22
+// end23
+// end24
+// end25
+// end26
+// end27
+// end28
+// end29
+// end30
+// end31
+// end32
+// end33
+// end34
+// end35
+// end36
+// end37
+// end38
+// end39
+// end40
+// end41
+// end42
+// end43
+// end44
+// end45
+// end46
+// end47
+// end48
+// end49
+// end50
+// end51
+// end52
+// end53
+// end54
+// end55
+// end56
+// end57
+// end58
+// end59
+// end60
+// end61
+// end62
+// end63
+// end64
+// end65
+// end66
+// end67
+// end68
+// end69
+// end70
+// end71
+// end72
+// end73
+// end74
+// end75
+// end76
+// end77
+// end78
+// end79
+// end80
 #endif
 }
diff --git a/src/server/scripts/Custom/CMakeLists.txt b/src/server/scripts/Custom/CMakeLists.txt
index 80ebe36..20c2bc9 100644
--- a/src/server/scripts/Custom/CMakeLists.txt
+++ b/src/server/scripts/Custom/CMakeLists.txt
@@ -8,11 +8,11 @@
 # WITHOUT ANY WARRANTY, to the extent permitted by law; without even the
 # implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 
-# file(GLOB_RECURSE sources_Custom Custom/*.cpp Custom/*.h)
+file(GLOB_RECURSE sources_Custom Custom/*.cpp Custom/*.h)
 
 set(scripts_STAT_SRCS
   ${scripts_STAT_SRCS}
-#  ${sources_Custom}
+  ${sources_Custom}
 )
 
 message("  -> Prepared: Custom")
diff --git a/src/server/shared/Database/Implementation/CharacterDatabase.cpp b/src/server/shared/Database/Implementation/CharacterDatabase.cpp
index f2e9ed8..e0fc421 100644
--- a/src/server/shared/Database/Implementation/CharacterDatabase.cpp
+++ b/src/server/shared/Database/Implementation/CharacterDatabase.cpp
@@ -632,4 +632,28 @@ void CharacterDatabaseConnection::DoPrepareStatements()
     PrepareStatement(CHAR_UPD_CHAR_PET_SLOT_BY_ID, "UPDATE character_pet SET slot = ? WHERE owner = ? AND id = ?", CONNECTION_ASYNC);
     PrepareStatement(CHAR_DEL_CHAR_PET_BY_ID, "DELETE FROM character_pet WHERE id = ?", CONNECTION_ASYNC);
     PrepareStatement(CHAR_DEL_CHAR_PET_BY_SLOT, "DELETE FROM character_pet WHERE owner = ? AND (slot = ? OR slot > ?)", CONNECTION_ASYNC);
+    // Prepatch by LordPsyan
+    // 01
+    // 02
+    // 03
+    // 04
+    // 05
+    // 06
+    // 07
+    // 08
+    // 09
+    // 10
+    // 11
+    // 12
+    // 13
+    // 14
+    // 15
+    // 16
+    // 17
+    // 18
+    // 19
+    // 20
+    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+    //
+    // End of prepatch
 }
diff --git a/src/server/shared/Database/Implementation/CharacterDatabase.h b/src/server/shared/Database/Implementation/CharacterDatabase.h
index 5accf57..79b3340 100644
--- a/src/server/shared/Database/Implementation/CharacterDatabase.h
+++ b/src/server/shared/Database/Implementation/CharacterDatabase.h
@@ -560,7 +560,30 @@ enum CharacterDatabaseStatements
     CHAR_SEL_ITEMCONTAINER_MONEY,
     CHAR_DEL_ITEMCONTAINER_MONEY,
     CHAR_INS_ITEMCONTAINER_MONEY,
-
+    // Prepatch by LordPsyan
+    // 01
+    // 02
+    // 03
+    // 04
+    // 05
+    // 06
+    // 07
+    // 08
+    // 09
+    // 10
+    // 11
+    // 12
+    // 13
+    // 14
+    // 15
+    // 16
+    // 17
+    // 18
+    // 19
+    // 20
+    // Visit http://www.realmsofwarcraft.com/bb for forums and information
+    //
+    // End of prepatch
     MAX_CHARACTERDATABASE_STATEMENTS
 };
 
diff --git a/src/server/worldserver/worldserver.conf.dist b/src/server/worldserver/worldserver.conf.dist
index a6cdd20..c345a5f 100644
--- a/src/server/worldserver/worldserver.conf.dist
+++ b/src/server/worldserver/worldserver.conf.dist
@@ -3,6 +3,28 @@
 ################################################
 [worldserver]
 
+################################################
+#         Prepatch config by LordPsyan         #
+#       http://www.realmsofwarcraft.com/       #
+################################################
+
+###################################################################################################
+#
+# Prepatch Configuration
+#
+#
+# If you add GuildLevelSystem or Individual XP Rate patches, you must
+# set this to 1.
+#
+# PrepatchGI Added
+#         default = 0 (GuildLevelSystem and Individual XP Rate not added)
+#                 = 1 (GuildLevelSystem and/or Individual XP Rate added)
+
+PrepatchGI.Added = 0
+
+#
+###################################################################################################
+
 ###################################################################################################
 # SECTION INDEX
 #
@@ -2924,3 +2946,8 @@ PacketSpoof.BanDuration = 86400
 
 #
 ###################################################################################################
+
+#
+# Prepatch by LordPsyan.
+# See http://www.realmsofwarcraft.com/bb for forums and information.
+#
-- 
2.1.0.rc1

